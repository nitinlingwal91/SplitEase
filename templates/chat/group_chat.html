{% extends 'base.html' %}

{% block title %}Chat - {{ group.name }}{% endblock %}

{% block content %}
<div class="row">
    <!-- Chat Column -->
    <div class="col-md-9">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-chat-dots"></i> {{ group.name }} - Group Chat
                </h5>
            </div>

            <!-- Messages Container - STRICTLY BOUNDED -->
            <div id="message-box"></div>

            <!-- Empty State -->
            <div id="empty-state" class="show">
                <i class="bi bi-chat-left-dots" style="font-size: 3rem; color: #ccc;"></i>
                <p style="margin-top: 15px; color: #6c757d;">No messages yet. Start the conversation!</p>
            </div>

            <!-- Message Input -->
            <div class="card-footer" style="padding: 15px; border-top: 1px solid #dee2e6;">
                <form id="chat-form" method="post" action="{% url 'chat:send_message' group.group_id %}">
                    {% csrf_token %}
                    <div class="input-group mb-2">
                        <input 
                            type="text" 
                            id="message-input" 
                            name="message"
                            class="form-control" 
                            placeholder="Type a message..."
                            autocomplete="off"
                            maxlength="1000"
                        >
                        <button type="submit" class="btn btn-primary" id="send-btn">
                            <i class="bi bi-send"></i> Send
                        </button>
                    </div>
                    <small id="char-count-display" class="text-muted d-block">
                        <span id="char-count">0</span>/1000 characters
                    </small>
                </form>
            </div>

            <!-- Back Link -->
            <div class="card-footer" style="padding: 12px 15px; background-color: transparent;">
                <a href="{% url 'groups:detail' group.group_id %}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-left"></i> Back to Group
                </a>
            </div>
        </div>
    </div>

    <!-- Online Members Sidebar -->
    <div class="col-md-3">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="bi bi-people"></i> Online (<span id="online-count">0</span>)
                </h5>
            </div>
            <div class="card-body" style="padding: 15px;">
                <div id="members-list">
                    <p class="text-center text-muted">Loading members...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const groupId = {{ group.group_id }};
const currentUserId = {{ request.user.user_id }};
const messageBox = document.getElementById('message-box');
const emptyState = document.getElementById('empty-state');
const messageInput = document.getElementById('message-input');
const charCount = document.getElementById('char-count');
const chatForm = document.getElementById('chat-form');
const sendBtn = document.getElementById('send-btn');
const membersList = document.getElementById('members-list');
const onlineCount = document.getElementById('online-count');

let lastMessageId = 0;
let messagesLoaded = false;

// Character count
messageInput.addEventListener('input', function() {
    charCount.textContent = this.value.length;
});

// Escape HTML
function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// Load messages
function loadMessages() {
    fetch(`{% url 'chat:get_messages' group.group_id %}?last_id=${lastMessageId}`)
        .then(response => response.json())
        .then(data => {
            if (data.messages && data.messages.length > 0) {
                emptyState.classList.remove('show');
                messagesLoaded = true;

                data.messages.forEach(msg => {
                    addMessageToUI(msg);
                    lastMessageId = msg.id;
                });
            } else if (!messagesLoaded) {
                emptyState.classList.add('show');
                messagesLoaded = true;
            }
        })
        .catch(error => console.error('Error:', error));
}

// Load online members
function loadOnlineMembers() {
    fetch(`{% url 'chat:online_members' group.group_id %}`)
        .then(response => response.json())
        .then(data => {
            membersList.innerHTML = '';
            
            if (data.members && data.members.length > 0) {
                onlineCount.textContent = data.members.length;
                
                // Only show members who are actually online
                const uniqueMembers = new Map();
                data.members.forEach(member => {
                    uniqueMembers.set(member.user__user_id, member.user__name);
                });
                
                if (uniqueMembers.size > 0) {
                    uniqueMembers.forEach((name, userId) => {
                        const div = document.createElement('div');
                        div.className = 'member-item';
                        
                        const isCurrentUser = userId === currentUserId;
                        const badgeClass = isCurrentUser ? 'bg-success' : 'bg-info';
                        const label = isCurrentUser ? ' (You)' : '';
                        
                        div.innerHTML = `
                            <div class="d-flex align-items-center">
                                <span class="badge ${badgeClass} rounded-pill">‚óè</span>
                                <strong>${escapeHtml(name)}${label}</strong>
                            </div>
                        `;
                        membersList.appendChild(div);
                    });
                } else {
                    membersList.innerHTML = '<p class="text-center text-muted">No members online</p>';
                    onlineCount.textContent = '0';
                }
            } else {
                membersList.innerHTML = '<p class="text-center text-muted">No members online</p>';
                onlineCount.textContent = '0';
            }
        })
        .catch(error => console.error('Error:', error));
}

// Add message - STRICT CONTAINMENT
function addMessageToUI(msg) {
    const isOwnMessage = msg.sender_id === currentUserId;
    
    const wrapper = document.createElement('div');
    wrapper.className = `message-wrapper ${isOwnMessage ? 'own' : ''}`;
    wrapper.style.display = 'flex';
    wrapper.style.width = '100%';
    wrapper.style.margin = '8px 0';
    wrapper.style.padding = '0';
    wrapper.style.boxSizing = 'border-box';
    wrapper.style.justifyContent = isOwnMessage ? 'flex-end' : 'flex-start';
    
    const div = document.createElement('div');
    div.className = `chat-message ${isOwnMessage ? 'own' : 'other'}`;
    div.style.display = 'block';
    div.style.width = 'auto';
    div.style.maxWidth = '75%';
    div.style.boxSizing = 'border-box';
    div.style.overflow = 'visible';
    
    const timestamp = new Date(msg.timestamp);
    const time = timestamp.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
    });
    
    div.innerHTML = `
        <div class="chat-message-header">${escapeHtml(msg.sender)}</div>
        <div class="chat-message-content">${escapeHtml(msg.content)}</div>
        <div class="chat-message-time">${time}</div>
    `;
    
    wrapper.appendChild(div);
    messageBox.appendChild(wrapper);
    messageBox.scrollTop = messageBox.scrollHeight;
}

// Send message
chatForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const message = messageInput.value.trim();
    if (!message) return;
    
    sendBtn.disabled = true;
    const formData = new FormData();
    formData.append('message', message);
    
    fetch(`{% url 'chat:send_message' group.group_id %}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageInput.value = '';
            charCount.textContent = '0';
            emptyState.classList.remove('show');
            addMessageToUI(data.message);
            loadOnlineMembers();
        } else {
            alert('Error: ' + (data.error || 'Failed to send'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error sending message');
    })
    .finally(() => {
        sendBtn.disabled = false;
        messageInput.focus();
    });
});

// Initial load
loadMessages();
loadOnlineMembers();

// Poll for messages
setInterval(loadMessages, 2000);

// Poll for members
setInterval(loadOnlineMembers, 10000);

// Theme observer - Force redraw on theme change
const observer = new MutationObserver(() => {
    // Trigger recalculation of styles
    const messages = document.querySelectorAll('.chat-message');
    messages.forEach(msg => {
        msg.offsetHeight; // Force reflow
    });
});

observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['data-bs-theme']
});
</script>

<style>
    #message-box {
        background-color: #ffffff;
        color: #212529;
        overflow: hidden;
        overflow-y: scroll;
        height: 500px;
        max-height: 500px;
        min-height: 500px;
        box-sizing: border-box;
        display: block;
        order: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 15px;

    }

    /* Prevent scrollbar from causing overflow */
    #message-box::-webkit-scrollbar {
        width: 8px;
    }

    #message-box::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    
    [data-bs-theme="dark"] #message-box {
        background-color: #2b2b2b;
    }

    [data-bs-theme="dark"] #message-box::-webkit-scrollbar-track {
        background: #333;
    }

    [data-bs-theme="dark"] #message-box::-webkit-scrollbar-thumb {
        background: #666;
    }

    /* Message wrapper - ensures containment */
    .message-wrapper {
        display: flex;
        width: 100%;
        margin: 8px 0;
        padding: 0;
        box-sizing: border-box;
        justify-content: flex-start;
    }

    .message-wrapper.own {
        justify-content: flex-end;
    }

    /* Chat message - ABSOLUTELY NO OVERFLOW */
    .chat-message {
        display: block;
        width: auto;
        max-width: 75%;
        padding: 10px 12px;
        border-radius: 6px;
        box-sizing: border-box;
        word-wrap: break-word;
        word-break: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        margin: 0;
        line-height: 1.4;
        overflow: visible;
    }

    /* Light mode - Other user messages */
    .chat-message.other {
        background-color: #e8f4f8;
        border-left: 4px solid #007bff;
        color: #212529;
        text-align: left;
    }

    /* Light mode - Own messages */
    .chat-message.own {
        background-color: #d4edda;
        border-left: 4px solid #28a745;
        color: #155724;
        text-align: left;
    }

    /* Dark mode - Other user messages */
    [data-bs-theme="dark"] .chat-message.other {
        background-color: #2b3a47 !important;
        color: #e9ecef !important;
        border-left-color: #0d6efd !important;
    }

    /* Dark mode - Own messages */
    [data-bs-theme="dark"] .chat-message.own {
        background-color: #1e3d2b !important;
        color: #90ee90 !important;
        border-left-color: #198754 !important;
    }

    /* Empty state - HIDE by default */
    #empty-state {
        display: none;
        text-align: center;
        color: #6c757d;
        padding: 40px 20px;
        width: 100%;
    }

    [data-bs-theme="dark"] #empty-state {
        color: #adb5bd !important;
    }

    #empty-state.show {
        display: block;
    }

    
    /* Online members sidebar */
    #members-list {
        max-height: 500px;
        overflow-y: auto;
        overflow-x: hidden;
    }

    #members-list::-webkit-scrollbar {
        width: 6px;
    }

    #members-list::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    [data-bs-theme="dark"] #members-list::-webkit-scrollbar-track {
        background: #333;
    }

    #members-list::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
    }

    [data-bs-theme="dark"] #members-list::-webkit-scrollbar-thumb {
        background: #666;
    }


    /* Member item */
    .member-item {
        margin-bottom: 8px;
        padding: 10px;
        border-radius: 6px;
        background-color: #f8f9fa;
        color: #212529;
    }

    [data-bs-theme="dark"] .member-item {
        background-color: #2b2b2b !important;
        color: #e9ecef !important;
        border: 1px solid #495057 !important;
    }

    .member-item .badge {
        display: inline-block;
        margin-right: 8px;
    }

    /* Input styling */
    #chat-form .input-group {
        gap: 6px;
    }

    <style>
    .alert {
        display: none !important;
    }

</style>

<script>
// Hide all alert messages on chat page
document.addEventListener('DOMContentLoaded', function() {
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(alert => alert.style.display = 'none');
});
</script>
{% endblock %}
